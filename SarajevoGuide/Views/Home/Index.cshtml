@{
    ViewData["Title"] = "Home";
}

<div class="map-container">
    <div class="sidebar">
        <p class="section-title">CATEGORY</p>
        <div class="btn-group-vertical w-100 mb-3">
            <button class="category-btn" data-category="Sight" onclick="filterMarkers('Sight')">
                <img src="/images/camera.png" alt="Sights" />
                <span>Sights</span>
            </button>
            <button class="category-btn" data-category="Event" onclick="filterMarkers('Event')">
                <img src="/images/event.png" alt="Events" />
                <span>Events</span>
            </button>
            <button class="category-btn" data-category="Rest" onclick="filterMarkers('Rest')">
                <img src="/images/coffee.png" alt="Rest" />
                <span>Rest</span>
            </button>
        </div>

        <p class="section-title">FILTERS</p>

        <div class="mb-4">
            <label class="filter-label">Date</label>
            <div class="radio-group">
                <label><input type="radio" name="date" /> Today</label>
                <label><input type="radio" name="date" /> Tomorrow</label>
                <label><input type="radio" name="date" /> This week</label>
                <label><input type="radio" name="date" /> Pick a date…</label>
            </div>
        </div>

        <div class="mb-4">
            <label class="filter-label">Cost</label>
            <div class="radio-group">
                <label><input type="radio" name="cost" /> $</label>
                <label><input type="radio" name="cost" /> $$</label>
                <label><input type="radio" name="cost" /> $$$</label>
            </div>
        </div>

        <div class="mb-4">
            <label class="filter-label">Distance</label>
            <input type="range" min="0" max="10" value="5" class="form-range custom-range">
            <div class="distance-labels"><span>0 m</span><span>10 km</span></div>
        </div>
    </div>

    <div class="map-and-cards" style="display: flex; flex-grow: 1;">
        <div id="eventCards" class="event-cards" style="display: none; width: 40%; padding-right: 16px;"></div>
        <div id="map" style="width: 60%; height: 600px;"></div>
    </div>

</div>
@section Scripts {
    <script>
        let map;
        let markers = [];
        let currentCategory = null;
        let allEvents = [];
        const bookmarkedIds = new Set();

        async function initMap() {
            const { Map } = await google.maps.importLibrary("maps");

            map = new Map(document.getElementById('map'), {
                center: { lat: 43.8563, lng: 18.4131 },
                zoom: 13,
            });

            const infoWindow = new google.maps.InfoWindow();

            const response = await fetch('/Events/GetEvents');
            allEvents = await response.json();

            allEvents.forEach(event => {
                const marker = new google.maps.Marker({
                    position: { lat: event.lat, lng: event.lng },
                    map: null,
                    title: event.name
                });

                marker.kategorija = event.kategorija;

                // Generate a random image URL using picsum.photos
                const randomImgUrl = `https://picsum.photos/seed/${Math.floor(Math.random() * 1000)}/200/120`;

                const infoHtml = `
                    <div style="max-width: 220px;">
                        <strong>${event.name}</strong><br>
                        <span>Category: ${event.kategorija}</span><br>
                        <img src="${randomImgUrl}" alt="random image" style="width: 100%; height: auto; margin-top: 8px; border-radius: 6px;" />
                    </div>
                `;

                marker.addListener("click", () => {
                    infoWindow.setContent(infoHtml);
                    infoWindow.open(map, marker);
                });

                markers.push(marker);
            });
        }

        function toggleBookmark(eventId) {
            const icon = document.querySelector(`.event-card[data-event-id="${eventId}"] .bookmark-icon`);
            if (bookmarkedIds.has(eventId)) {
                bookmarkedIds.delete(eventId);
                icon.classList.remove('active');
                icon.textContent = '♡';
            } else {
                bookmarkedIds.add(eventId);
                icon.classList.add('active');
                icon.textContent = '♥';
            }
            localStorage.setItem("bookmarkedEventIds", JSON.stringify([...bookmarkedIds]));
        }

        function renderCards(category) {
            const container = document.getElementById("eventCards");
            container.innerHTML = "";

            const filteredEvents = allEvents.filter(e => e.kategorija === category);

            filteredEvents.forEach(e => {
                container.innerHTML += `
                    <div class="event-card mb-4" data-event-id="${e.id}">
                        <div class="card-image-placeholder">
                            <svg width="50" height="50"><circle cx="25" cy="25" r="20" fill="#bbb" /></svg>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">${e.name}</h3>
                            <p class="card-subtitle">${e.description ? e.description : ''}</p>
                            <div class="card-rating">
                                <span class="star">★</span><span class="star">★</span><span class="star">★</span>
                                <span class="star">☆</span><span class="star">☆</span>
                                <span class="rating-text">3.0</span>
                            </div>
                            <div class="card-footer d-flex justify-content-between align-items-center mt-3">
                                <span class="bookmark-icon" onclick="toggleBookmark(${e.id})">♡</span>
                                 ${
                                 e.kategorija === 'Event'
                                ? `<div class="d-flex gap-2">
                                <a href="/Recenzije/Create?eventId=${e.id}" class="btn btn-outline-secondary btn-sm">Ostavi recenziju</a>
                                <button class="btn btn-primary btn-sm">Kupi</button>
                                 </div>`
                                : `<a href="/Recenzije/Create?eventId=${e.id}" class="btn btn-outline-secondary btn-sm">Ostavi recenziju</a>`
                                }
                            </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }


        function filterMarkers(category) {
            const allButtons = document.querySelectorAll('.category-btn');
            const container = document.getElementById("eventCards");

            if (currentCategory === category) {
                currentCategory = null;
                allButtons.forEach(btn => btn.classList.remove('active'));
                markers.forEach(marker => marker.setMap(null));
                container.style.display = "none";
            } else {
                currentCategory = category;
                allButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.category === category) btn.classList.add('active');
                });
                markers.forEach(marker => {
                    marker.setMap(marker.kategorija === category ? map : null);

                });
                container.style.display = "block";
                renderCards(category);
            }
        }

        window.initMap = initMap;
    </script>
    <!--  Load Google Maps API -->
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAFJUeEaeMvw0dht4bnVPCb799EFW-8-Ao&callback=initMap">
    </script>
}
